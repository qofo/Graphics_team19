<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
<title>Example1</title>

<script id="vertex-shader" type="x-shader/x-vertex">
attribute vec4 vPosition;
attribute vec3 vNormal;

attribute vec2 vTexCoord;


uniform mat4 modelViewMatrix;
uniform mat4 projectionMatrix;
uniform mat4 normalMatrix;
uniform mat4 shadowMatrix;

varying vec3 fNormal;
varying vec3 fPosition;
varying vec4 vShadowCoord;

varying vec2 fTexCoord;

void main() {
    vec4 pos = modelViewMatrix * vPosition;
    fPosition = pos.xyz;
    fNormal = normalize((normalMatrix * vec4(vNormal, 0.0)).xyz);
    fTexCoord = vTexCoord;
    vShadowCoord = shadowMatrix * vPosition;

    gl_Position = projectionMatrix * pos;
}

</script>

<script id="fragment-shader" type="x-shader/x-fragment">
// set precision to mediump
precision mediump float;

varying vec3 fNormal;
varying vec3 fPosition;

varying vec2 fTexCoord;
varying vec4 vShadowCoord;

uniform sampler2D texture;
uniform sampler2D shadowMap;



uniform vec4 ambientProduct;
uniform vec4 diffuseProduct;
uniform vec4 specularProduct;
uniform vec4 lightPosition;
uniform float shininess;

uniform sampler2D textureSam;

void main() {
    vec3 N = normalize(fNormal);
    vec3 L;
    if (lightPosition.w == 0.0)
        L = normalize(lightPosition.xyz);
    else
        L = normalize(lightPosition.xyz - fPosition);

    vec3 E = normalize(-fPosition);
    vec3 H = normalize(L + E);

    float Kd = max(dot(N, L), 0.0);
    float Ks = pow(max(dot(N, H), 0.0), shininess);

    vec4 ambient = ambientProduct;
    vec4 diffuse = Kd * diffuseProduct;
    vec4 specular = (dot(N, L) < 0.0) ? vec4(0.0) : Ks * specularProduct;


    vec4 texColor = texture2D(texture, fTexCoord);
    vec3 projCoords = vShadowCoord.xyz / vShadowCoord.w;
    float closest = texture2D(shadowMap, projCoords.xy).r;
    float current = projCoords.z;
    float shadow = current - 0.005 > closest ? 0.5 : 1.0;

    gl_FragColor = texColor * (ambient + diffuse + specular) * shadow;
    gl_FragColor.a = 1.0;
}
</script>

<script type="text/javascript" src="../Common/webgl-utils.js"></script>
<script type="text/javascript" src="../Common/initShaders.js"></script>
<script type="text/javascript" src="../Common/MV.js"></script>
<script type="text/javascript" src="app.js"></script>
<script type="text/javascript" src="character.js"></script>
<script type="text/javascript" src="controller.js"></script>
<script type="text/javascript" src="renderer.js"></script>
</head>

<body>
<canvas id="gl-canvas" width="1024" height="1024">
Oops ... your browser doesn't support the HTML5 canvas element
</canvas>

<div id="ui">
  <div id="distance">0</div>
  <label>Light X
    <input id="light-x" type="range" min="-10" max="10" step="0.1" value="0">
  </label>
  <label>Light Y
    <input id="light-y" type="range" min="-10" max="10" step="0.1" value="5">
  </label>
  <label>Light Z
    <input id="light-z" type="range" min="-10" max="10" step="0.1" value="0">
  </label>
</div>

</body>
</html>
